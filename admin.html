<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Myanmar:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans Myanmar', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-animation {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .sidebar-icon {
            width: 24px;
            height: 24px;
        }
        /* Custom scrollbar for webkit browsers */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body class="bg-slate-100">

    <div id="app-container">

        <div id="login-view" class="flex items-center justify-center min-h-screen bg-gray-100">
            <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-2xl shadow-lg">
                <div>
                    <h2 class="text-3xl font-bold text-center text-gray-900">Admin Dashboard</h2>
                    <p class="mt-2 text-center text-sm text-gray-600">Sign in to manage orders and menu</p>
                </div>
                <form id="login-form" class="mt-8 space-y-6">
                    <div class="rounded-md shadow-sm -space-y-px">
                        <div>
                            <label for="email" class="sr-only">Email address</label>
                            <input id="email" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Email address">
                        </div>
                        <div>
                            <label for="password" class="sr-only">Password</label>
                            <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Password">
                        </div>
                    </div>
                    <div>
                        <button type="submit" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                            Sign In
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="main-app" class="hidden">
            <div class="flex h-screen bg-slate-100">
                <aside class="w-64 bg-white shadow-md flex-shrink-0 hidden md:flex flex-col">
                    <div class="h-16 flex items-center justify-center border-b">
                        <h1 class="text-xl font-bold text-indigo-600">Order Admin</h1>
                    </div>
                    <nav class="flex-1 p-4 space-y-2">
                        <a href="#" onclick="switchView('dashboard')" class="nav-link flex items-center px-4 py-2 text-gray-700 bg-indigo-50 rounded-lg">
                            <svg class="sidebar-icon mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                            Dashboard
                        </a>
                        <a href="#" onclick="switchView('menu')" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-indigo-50 rounded-lg">
                             <svg class="sidebar-icon mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                            Menu Items
                        </a>
                        <a href="#" onclick="switchView('records')" class="nav-link flex items-center px-4 py-2 text-gray-600 hover:bg-indigo-50 rounded-lg">
                            <svg class="sidebar-icon mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            Order Records
                        </a>
                    </nav>
                    <div class="p-4 border-t">
                         <button onclick="logout()" class="w-full flex items-center justify-center px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-50 rounded-lg">
                            <svg class="sidebar-icon mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            Sign Out
                        </button>
                    </div>
                </aside>

                <main class="flex-1 flex flex-col overflow-hidden">
                    <header class="h-16 bg-white shadow-sm flex justify-between items-center px-6">
                        <button class="md:hidden" id="mobile-menu-button">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                        <h2 id="view-title" class="text-xl font-semibold text-gray-800">Dashboard</h2>
                        <div id="header-actions"></div>
                    </header>
                    
                    <div class="flex-1 p-4 md:p-6 lg:p-8 overflow-y-auto custom-scrollbar">
                        <div id="dashboard-view">
                             <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                                <div class="lg:col-span-2 xl:col-span-3">
                                    <h2 class="text-2xl font-bold mb-4 text-gray-700">Active Orders</h2>
                                </div>
                                <div id="active-orders" class="space-y-4"></div>
                                <div id="preparing-orders" class="space-y-4"></div>
                                <div id="payment-due-orders" class="space-y-4"></div>
                            </div>
                        </div>

                        <div id="menu-view" class="hidden">
                            </div>

                        <div id="records-view" class="hidden">
                            <div id="records-list" class="bg-white rounded-xl shadow-lg p-6 space-y-4"></div>
                        </div>
                    </div>
                </main>
            </div>
        </div>

    </div>

    <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm mx-auto text-center fade-in-animation">
            <p id="modal-message" class="text-lg mb-6"></p>
            <button onclick="closeModal('message-modal')" class="bg-indigo-600 text-white rounded-lg px-6 py-2 font-semibold hover:bg-indigo-700 transition-colors">Close</button>
        </div>
    </div>
    
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm mx-auto text-center fade-in-animation">
            <p id="confirm-modal-message" class="text-lg mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="bg-gray-200 text-gray-800 rounded-lg px-6 py-2 font-semibold hover:bg-gray-300 transition-colors">Cancel</button>
                <button id="confirm-ok-btn" class="bg-red-600 text-white rounded-lg px-6 py-2 font-semibold hover:bg-red-700 transition-colors">Confirm</button>
            </div>
        </div>
    </div>
    
    <div id="menu-item-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 p-4">
        <div class="bg-white rounded-xl shadow-lg p-8 w-full max-w-md fade-in-animation">
            <h2 id="menu-item-modal-title" class="text-2xl font-bold mb-6 text-gray-800">Add New Item</h2>
            <form id="menu-item-form">
                <input type="hidden" id="menu-item-id">
                <div class="space-y-4">
                    <div>
                        <label for="item-name" class="block text-sm font-medium text-gray-700">Item Name</label>
                        <input type="text" id="item-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., Mohinga">
                    </div>
                    <div>
                        <label for="item-price" class="block text-sm font-medium text-gray-700">Price</label>
                        <input type="number" id="item-price" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., 40">
                    </div>
                    <div>
                        <label for="item-image" class="block text-sm font-medium text-gray-700">Image URL</label>
                        <input type="url" id="item-image" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="https://.../mohinga.jpg">
                    </div>
                     <div>
                        <label for="item-category" class="block text-sm font-medium text-gray-700">Category</label>
                        <input type="text" id="item-category" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., အသုပ်များ">
                    </div>
                </div>
                <div class="mt-8 flex justify-end gap-4">
                    <button type="button" onclick="closeModal('menu-item-modal')" class="bg-gray-200 text-gray-800 rounded-lg py-2 px-4 font-semibold hover:bg-gray-300 transition-colors">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white rounded-lg py-2 px-4 font-semibold hover:bg-indigo-700 transition-colors">Save Item</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, updateDoc, setLogLevel, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION & INITIALIZATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyC6xVXYg01N67cIo_vDQANhnEmkz-LSGfk",
            authDomain: "akari-qr-order-system.firebaseapp.com",
            projectId: "akari-qr-order-system",
            storageBucket: "akari-qr-order-system.appspot.com",
            messagingSenderId: "646414842831",
            appId: "1:646414842831:web:0b76fc26030ba4d9a5b3fe"
        };

        let app, auth, db;
        let ordersCollectionRef, menuCollectionRef;
        let ordersUnsubscribe = null;
        let menuUnsubscribe = null;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('debug'); 

            // CORRECTED: Use the simple, top-level collection paths to match the customer app
            ordersCollectionRef = collection(db, "orders");
            menuCollectionRef = collection(db, "menu");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            showModal("Could not connect to the service. Please refresh.");
        }
        
        // --- DOM ELEMENTS ---
        const loginView = document.getElementById('login-view');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const viewTitle = document.getElementById('view-title');
        const headerActions = document.getElementById('header-actions');
        const navLinks = document.querySelectorAll('.nav-link');

        const views = {
            dashboard: document.getElementById('dashboard-view'),
            menu: document.getElementById('menu-view'),
            records: document.getElementById('records-view')
        };
        
        const orderContainers = {
            Pending: document.getElementById('active-orders'),
            Preparing: document.getElementById('preparing-orders'),
            Ready: document.getElementById('payment-due-orders')
        };
        
        const menuItemForm = document.getElementById('menu-item-form');
        const menuItemModal = document.getElementById('menu-item-modal');
        const menuItemModalTitle = document.getElementById('menu-item-modal-title');
        const menuItemIdInput = document.getElementById('menu-item-id');

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginView.classList.add('hidden');
                mainApp.classList.remove('hidden');
                initApp();
            } else {
                mainApp.classList.add('hidden');
                loginView.classList.remove('hidden');
                if (ordersUnsubscribe) ordersUnsubscribe();
                if (menuUnsubscribe) menuUnsubscribe();
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login failed:", error);
                showModal("Login failed. Please check your credentials.");
            }
        });

        window.logout = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign out failed:", error);
            }
        };

        // --- APP INITIALIZATION ---
        function initApp() {
            switchView('dashboard');
            // Mobile menu toggle
            document.getElementById('mobile-menu-button').addEventListener('click', () => {
                document.querySelector('aside').classList.toggle('hidden');
            });
        }

        // --- VIEW MANAGEMENT ---
        window.switchView = (viewName) => {
            Object.values(views).forEach(v => v.classList.add('hidden'));
            views[viewName].classList.remove('hidden');
            viewTitle.textContent = viewName.charAt(0).toUpperCase() + viewName.slice(1);
            
            navLinks.forEach(link => {
                link.classList.remove('bg-indigo-50', 'text-gray-900', 'font-semibold');
                if (link.getAttribute('onclick').includes(viewName)) {
                    link.classList.add('bg-indigo-50', 'text-gray-900', 'font-semibold');
                }
            });

            // Detach old listeners
            if (ordersUnsubscribe) ordersUnsubscribe();
            if (menuUnsubscribe) menuUnsubscribe();
            
            // Attach listeners and setup for the current view
            headerActions.innerHTML = '';
            if (viewName === 'dashboard') {
                listenForOrders();
                const clearButton = document.createElement('button');
                clearButton.className = "bg-yellow-100 text-yellow-800 shadow-sm rounded-lg px-4 py-2 text-sm font-medium hover:bg-yellow-200 transition-all";
                clearButton.textContent = "Clear Completed";
                clearButton.onclick = () => confirmAction('Are you sure you want to clear ALL completed orders?', clearCompletedOrders);
                headerActions.appendChild(clearButton);
            } else if (viewName === 'menu') {
                listenForMenu();
                const addButton = document.createElement('button');
                addButton.className = "bg-indigo-600 text-white shadow-sm rounded-lg px-4 py-2 text-sm font-medium hover:bg-indigo-700 transition-all flex items-center";
                addButton.innerHTML = `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg> Add Item`;
                addButton.onclick = openNewMenuItemModal;
                headerActions.appendChild(addButton);
            } else if (viewName === 'records') {
                listenForCompletedOrders();
            }
        };

        // --- FIRESTORE LISTENERS ---
        const statusConfig = {
            'Pending': { color: 'red', nextAction: 'Start Cooking', nextStatus: 'Preparing' },
            'Preparing': { color: 'yellow', nextAction: 'Mark as Ready', nextStatus: 'Ready' },
            'Ready': { color: 'green', nextAction: 'Mark as Paid', nextStatus: 'Completed' }
        };

        function listenForOrders() {
            const q = query(ordersCollectionRef, where("status", "in", ["Pending", "Preparing", "Ready"]));
            ordersUnsubscribe = onSnapshot(q, (snapshot) => {
                // Clear containers initially
                Object.values(orderContainers).forEach(c => { 
                    if(c) {
                        const title = c.id.replace('-orders', '').replace('-', ' ');
                        c.innerHTML = `<h3 class="font-bold text-lg text-slate-600 mb-2 capitalize">${title}</h3>`;
                    }
                });

                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added" && change.doc.data().status === 'Pending') {
                        try {
                            const synth = new Tone.Synth().toDestination();
                            synth.triggerAttackRelease("C5", "8n", Tone.now());
                        } catch(e) { console.error("Could not play sound", e); }
                    }
                });

                const sortedDocs = snapshot.docs.sort((a, b) => {
                    const timeA = a.data().createdAt?.seconds || 0;
                    const timeB = b.data().createdAt?.seconds || 0;
                    return timeA - timeB;
                });
                
                sortedDocs.forEach(doc => renderOrderCard({ id: doc.id, ...doc.data() }));

            }, (error) => console.error("Error listening to orders:", error));
        }

        function listenForCompletedOrders() {
            const recordsList = document.getElementById('records-list');
            const q = query(ordersCollectionRef, where("status", "==", "Completed"));
            ordersUnsubscribe = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    recordsList.innerHTML = '<p class="text-center text-gray-500 py-8">No completed orders found.</p>';
                    return;
                }
                recordsList.innerHTML = '';
                const sortedDocs = snapshot.docs.sort((a, b) => {
                    const timeA = a.data().createdAt?.seconds || 0;
                    const timeB = b.data().createdAt?.seconds || 0;
                    return timeB - timeA;
                });
                sortedDocs.forEach(doc => renderRecordCard({ id: doc.id, ...doc.data() }));
            });
        }

        function listenForMenu() {
            const menuView = document.getElementById('menu-view');
            menuUnsubscribe = onSnapshot(menuCollectionRef, (snapshot) => {
                menuView.innerHTML = '';
                if (snapshot.empty) {
                    menuView.innerHTML = '<p class="text-center text-gray-500 py-8">No menu items found. Add one to get started!</p>';
                    return;
                }
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6';
                snapshot.docs.forEach(doc => {
                    grid.appendChild(renderMenuItemAdminCard({ id: doc.id, ...doc.data() }));
                });
                menuView.appendChild(grid);
            });
        }

        // --- RENDER FUNCTIONS ---
        function renderOrderCard(order) {
            const config = statusConfig[order.status];
            if (!config || !orderContainers[order.status]) return;

            const card = document.createElement('div');
            card.className = `bg-white rounded-xl shadow-md p-4 border-l-4 border-${config.color}-500 fade-in-animation`;
            
            const itemsHtml = order.items.map(item => {
                let commentHtml = item.comment ? `<span class="text-xs text-gray-500 italic ml-2">(${item.comment})</span>` : '';
                return `<li class="flex justify-between text-sm"><span>${item.quantity} x ${item.name} ${commentHtml}</span><span class="font-mono text-gray-600">฿${(item.quantity * item.price).toFixed(2)}</span></li>`;
            }).join('');

            const orderTime = order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) : 'N/A';
            
            card.innerHTML = `
                <div class="flex justify-between items-start pb-2 mb-2">
                    <div>
                        <h3 class="font-bold text-lg text-gray-800">${order.customerName}</h3>
                        <p class="text-sm text-gray-500">${order.customerPhone || 'No phone'}</p>
                        ${order.customerAddress ? `<p class="text-xs text-gray-500 mt-1">${order.customerAddress}</p>` : ''}
                    </div>
                    <div class="text-right">
                        <span class="font-semibold text-sm text-gray-600">${orderTime}</span>
                        ${order.orderType ? `<span class="mt-1 text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full bg-blue-100 text-blue-800">${order.orderType}</span>` : ''}
                    </div>
                </div>
                <ul class="space-y-1 mb-4 border-t pt-2">${itemsHtml}</ul>
                <div class="border-t pt-2 flex justify-end font-bold text-lg">Total: ฿${Number(order.totalPrice).toFixed(2)}</div>
                <div class="flex gap-2 mt-4">
                    <button onclick="updateOrderStatus('${order.id}', '${config.nextStatus}')" class="w-full bg-${config.color}-500 text-white font-semibold py-2 rounded-lg hover:bg-${config.color}-600 transition-all">${config.nextAction}</button>
                    <button onclick="confirmAction('Remove order for ${order.customerName.replace(/'/g, "\\'") }?', () => removeOrder('${order.id}'))" class="bg-red-100 text-red-700 font-semibold py-2 px-4 rounded-lg hover:bg-red-200 transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>`;
            
            orderContainers[order.status].appendChild(card);
        }
        
        function renderMenuItemAdminCard(item) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-md overflow-hidden flex flex-col';
            card.innerHTML = `
                <img src="${item.image}" alt="${item.name}" class="w-full h-40 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x300/e2e8f0/64748b?text=No+Image';">
                <div class="p-4 flex-grow flex flex-col">
                    <h3 class="font-bold text-lg text-gray-800">${item.name}</h3>
                    <p class="text-gray-600 font-mono">฿${Number(item.price).toFixed(2)}</p>
                    <div class="mt-4 pt-4 border-t flex-grow flex items-end justify-end gap-2">
                        <button onclick="openEditMenuItemModal('${item.id}', '${item.name.replace(/'/g, "\\'")}', ${item.price}, '${item.image}', '${item.category ? item.category.replace(/'/g, "\\'") : ''}')" class="text-sm bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-all">Edit</button>
                        <button onclick="confirmAction('Delete ${item.name.replace(/'/g, "\\'") }?', () => deleteMenuItem('${item.id}'))" class="text-sm bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-all">Delete</button>
                    </div>
                </div>
            `;
            return card;
        }

        function renderRecordCard(order) {
            const recordsList = document.getElementById('records-list');
            const orderDate = order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleString('en-GB') : 'N/A';
            const itemsHtml = order.items.map(item => `<li>${item.quantity} x ${item.name}</li>`).join('');
            
            const recordEl = document.createElement('div');
            recordEl.className = 'p-4 border-b';
            recordEl.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-bold text-gray-800">${order.customerName}</p>
                        <p class="text-sm text-gray-500">${order.customerPhone || ''}</p>
                    </div>
                    <p class="text-sm text-gray-500">${orderDate}</p>
                </div>
                <ul class="list-disc list-inside text-sm my-2 ml-4">${itemsHtml}</ul>
                <p class="text-right font-bold mt-2">Total: ฿${Number(order.totalPrice).toFixed(2)}</p>
            `;
            recordsList.appendChild(recordEl);
        }

        // --- FIRESTORE ACTIONS ---
        window.updateOrderStatus = async (orderId, newStatus) => {
            const orderRef = doc(db, "orders", orderId); // CORRECTED
            try {
                await updateDoc(orderRef, { status: newStatus });
            } catch (error) {
                console.error("Error updating order status:", error);
                showModal("Failed to update order.");
            }
        };

        window.removeOrder = async (orderId) => {
            try {
                await deleteDoc(doc(db, "orders", orderId)); // CORRECTED
                showModal("Order removed successfully.");
            } catch (error) {
                console.error("Error removing order: ", error);
                showModal("Failed to remove order.");
            }
        };

        window.clearCompletedOrders = async () => {
            const q = query(ordersCollectionRef, where("status", "==", "Completed"));
            try {
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    showModal("No completed orders to clear.");
                    return;
                }
                const batch = [];
                querySnapshot.docs.forEach(docSnapshot => {
                    batch.push(deleteDoc(doc(db, "orders", docSnapshot.id))); // CORRECTED
                });
                await Promise.all(batch);
                showModal(`Successfully cleared ${querySnapshot.size} completed order(s).`);
            } catch (error) {
                console.error("Error clearing completed orders: ", error);
                showModal("Failed to clear completed orders.");
            }
        };

        menuItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = menuItemIdInput.value;
            const itemData = {
                name: document.getElementById('item-name').value,
                price: parseFloat(document.getElementById('item-price').value),
                image: document.getElementById('item-image').value,
                category: document.getElementById('item-category').value,
            };

            if (!itemData.name || isNaN(itemData.price) || !itemData.image || !itemData.category) {
                showModal("Please fill out all fields correctly.");
                return;
            }

            try {
                if (id) { // Editing existing item
                    await updateDoc(doc(db, "menu", id), itemData); // CORRECTED
                    showModal("Menu item updated successfully!");
                } else { // Adding new item
                    await addDoc(menuCollectionRef, itemData);
                    showModal("Menu item added successfully!");
                }
                closeModal('menu-item-modal');
            } catch (error) {
                console.error("Error saving menu item:", error);
                showModal("Failed to save menu item. Check permissions.");
            }
        });

        window.deleteMenuItem = async (id) => {
            try {
                await deleteDoc(doc(db, "menu", id)); // CORRECTED
                showModal("Menu item deleted.");
            } catch (error) {
                console.error("Error deleting menu item:", error);
                showModal("Failed to delete menu item.");
            }
        };

        // --- MODAL & UI HELPERS ---
        window.showModal = (message) => {
            document.getElementById('modal-message').textContent = message;
            document.getElementById('message-modal').classList.remove('hidden');
        }
        
        window.closeModal = (modalId) => {
            document.getElementById(modalId).classList.add('hidden');
        }

        window.confirmAction = (message, callback) => {
            const confirmModal = document.getElementById('confirm-modal');
            document.getElementById('confirm-modal-message').textContent = message;
            confirmModal.classList.remove('hidden');

            const okBtn = document.getElementById('confirm-ok-btn');
            const cancelBtn = document.getElementById('confirm-cancel-btn');

            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);
            
            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

            const cleanup = () => {
                confirmModal.classList.add('hidden');
            };

            newOkBtn.addEventListener('click', () => {
                callback();
                cleanup();
            });
            newCancelBtn.addEventListener('click', cleanup);
        }

        window.openNewMenuItemModal = () => {
            menuItemForm.reset();
            menuItemIdInput.value = '';
            menuItemModalTitle.textContent = 'Add New Item';
            menuItemModal.classList.remove('hidden');
        }

        window.openEditMenuItemModal = (id, name, price, image, category) => {
            menuItemForm.reset();
            menuItemIdInput.value = id;
            document.getElementById('item-name').value = name;
            document.getElementById('item-price').value = price;
            document.getElementById('item-image').value = image;
            document.getElementById('item-category').value = category || '';
            menuItemModalTitle.textContent = 'Edit Item';
            menuItemModal.classList.remove('hidden');
        }

        // --- GLOBAL CLICK LISTENER FOR MODALS ---
        window.addEventListener('click', function(event) {
            if (event.target.id === 'menu-item-modal' || event.target.id === 'confirm-modal' || event.target.id === 'message-modal') {
                closeModal(event.target.id);
            }
        });

    </script>
</body>
</html>
